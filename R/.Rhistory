da <- list()
batch_size <- N
n_batches <- ceiling(ncol(fit$coefficients)/batch_size)
for (i in 1:n_batches) {
contrast_subset <- contrast_list[((i - 1) * batch_size + 1):min(i * batch_size, length(contrast_list))]
contrast.matrix <- makeContrasts(contrasts = contrast_subset, levels = design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit3 <- eBayes(fit2, robust = TRUE, trend = TRUE)
new_contrast_names <- c()
# Store topTables for each contrast
for (contrast_name in colnames(contrast.matrix)) {
da[[contrast_name]] <- topTable(fit3, coef = contrast_name, adjust.method = 'BH', number = Inf, sort.by = 'none')
da[[contrast_name]][[strain_name_column]] <- rep(contrast_name, nrow(da[[contrast_name]]))
}
}
# Here we have a topTable per strain - now join them all and filter to keep only significantly DE proteins
## With a fixed logFC threshold
da <- bind_rows(da) %>%
dplyr::mutate(protein = rep(rownames(da[[1]]), times = length(da))) %>%
dplyr::distinct(get(strain_name_column), protein, logFC, .keep_all = T)
temp <- metadata %>%
dplyr::distinct(get(strain_name_column), .keep_all = T)
da <- left_join(da, temp, by = strain_name_column) %>%
dplyr::relocate(get(strain_name_column), .before = logFC) %>%
dplyr::relocate(protein, .after = get(strain_name_column)) %>%
dplyr::filter(get(strain_name_column) != "WT")
da <- da %>%
dplyr::select(protein, get(strain_name_column), logFC, P.Value, adj.P.Val) %>%                              # From here on in this function it's added by me
dplyr::mutate(diffexpressed_adjusted = case_when((logFC > lfc_threshold) & (adj.P.Val < alpha) ~ "Up_regulated",
(logFC < -lfc_threshold) & (adj.P.Val < alpha) ~ "Down_regulated",
TRUE ~ "Not_significant"),
diffexpressed_non_adjusted = case_when((logFC > lfc_threshold) & (P.Value < alpha) ~ "Up_regulated",
(logFC < -lfc_threshold) & (P.Value < alpha) ~ "Down_regulated",
TRUE ~ "Not_significant"))
da <- da %>%
dplyr::distinct(get(strain_name_column), protein, logFC, .keep_all = T)
## With a dynamically defined logFC threshold
#TODO
# Prepare output
output <- list("DE_df" = da, "lm_fit": fit, "contrasts_fit" = fit2, "eBayes_fit" = fit3)
return(output)
}
# Run differential expression analysis
## I am not sure how to do this! Should I check DE for all strains w.r.t. to a single baseline one? Or should I do it separately for each culture method (pellet, liquid, liquid+fluconazole)??? For now I am going to run it once for all strains with C0L (lab strain, passage 0, liquid media) as a reference and see what happens
de_analysis_results <- de_analysis_with_limma(raw_data = protein_mat,
metadata = metadata,
strain_name_column = "Strain.Name",
sample_name_column = "Sample.Name",
reference_strain = "C0L")
# Debug DE function
raw_data = protein_mat
metadata = metadata
strain_name_column = "Strain.Name"
sample_name_column = "Sample.Name"
reference_strain = "C0L"
# Generate the design matrix
## Get the names of all strains, and set the reference strain
my_levels <- c()
for (i in 1:ncol(raw_data)) {
sample_name <- colnames(raw_data)[i]
strain_name <- metadata[[strain_name_column]][metadata[[sample_name_column]] == sample_name]
if (length(strain_name) > 1) {
strain_name <- strain_name[1]
}
my_levels <- c(my_levels, strain_name)
}
my_levels <- as.factor(my_levels)
my_levels <- relevel(my_levels, ref = reference_strain)
## Generate design matrix
mm <- model.matrix(~ 0 + my_levels)
colnames(mm) <- levels(my_levels)
# Fit linear models with limpa
fit <- lmFit(raw_data, mm)
# Create contrasts - we remove the contrast of the reference strain to itself
treatments <- colnames(fit$coefficients)
design <- model.matrix(~ 0 + treatments)
colnames(design) <- treatments
contrast_list <- paste0(treatments, "-", reference_strain)
contrast_list <- contrast_list[!(contrast_list %in% c(paste(reference_strain, "-", reference_strain, sep="")))]
# Introduce the contrasts and run eBayes for them, 10 at a time - this batches helps with the issues estimating variability I think?
da <- list()
batch_size <- N
N = 10
n_batches <- ceiling(ncol(fit$coefficients)/batch_size)
# Run differential expression analysis
## I am not sure how to do this! Should I check DE for all strains w.r.t. to a single baseline one? Or should I do it separately for each culture method (pellet, liquid, liquid+fluconazole)??? For now I am going to run it once for all strains with C0L (lab strain, passage 0, liquid media) as a reference and see what happens
de_analysis_results <- de_analysis_with_limma(raw_data = protein_mat,
metadata = metadata,
strain_name_column = "Strain.Name",
sample_name_column = "Sample.Name",
reference_strain = "C0L")
N = 10
lfc_threshold = 1
alpha = 0.05
my_levels <- c()
for (i in 1:ncol(raw_data)) {
sample_name <- colnames(raw_data)[i]
strain_name <- metadata[[strain_name_column]][metadata[[sample_name_column]] == sample_name]
if (length(strain_name) > 1) {
strain_name <- strain_name[1]
}
my_levels <- c(my_levels, strain_name)
}
my_levels <- as.factor(my_levels)
my_levels <- relevel(my_levels, ref = reference_strain)
## Generate design matrix
mm <- model.matrix(~ 0 + my_levels)
colnames(mm) <- levels(my_levels)
# Fit linear models with limpa
fit <- lmFit(raw_data, mm)
# Create contrasts - we remove the contrast of the reference strain to itself
treatments <- colnames(fit$coefficients)
design <- model.matrix(~ 0 + treatments)
colnames(design) <- treatments
contrast_list <- paste0(treatments, "-", reference_strain)
contrast_list <- contrast_list[!(contrast_list %in% c(paste(reference_strain, "-", reference_strain, sep="")))]
# Introduce the contrasts and run eBayes for them, 10 at a time - this batches helps with the issues estimating variability I think?
da <- list()
batch_size <- N
n_batches <- ceiling(ncol(fit$coefficients)/batch_size)
i = 1
contrast_subset <- contrast_list[((i - 1) * batch_size + 1):min(i * batch_size, length(contrast_list))]
contrast.matrix <- makeContrasts(contrasts = contrast_subset, levels = design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit3 <- eBayes(fit2, robust = TRUE, trend = TRUE)
View(fit2)
View(protein_mat)
sum(protein_mat == 0)
sum(protein_mat == 0, na.rm = T)
sum(is.na(protein_mat))
gc()
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(data.table)
library(limpa)
library(helperfunctions)
library(preprocessCore)
working_from <- "charite"
if (working_from == "home") {
base_dir = "/home/alvaro/MyStuff/"
} else
if (working_from == "charite") {
base_dir = "C:/MyStuff/"
}
# Precursor data wide format
raw_prec_data <- as.matrix(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/report_wide_filtered_norm_drift_corrected_log2.csv", sep="")), rownames = 1)
# Metadata
metadata <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/metadata/metadata_processed.txt", sep="")))
# Correspondence between precursor IDs and protein IDs (UniProt)
precursor_protein_correspondence <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/precursor_protein_correspondence.tsv", sep="")))
# UniProt dataframe
uniprot_db <- as.data.frame(fread(paste(base_dir, "tRNA_KOs/Data/databases/uniprotkb_proteome_UP000002311_2025_05_24.tsv", sep="")))
# Prepare protein ID vector matching the precursor order in the rows of the raw data
## Set the order based on that of the rows of the precursor raw data
precursor_protein_correspondence <- precursor_protein_correspondence %>%
dplyr::filter(Precursor.Id %in% rownames(raw_prec_data))
precursor_protein_correspondence <- precursor_protein_correspondence[match(rownames(raw_prec_data), precursor_protein_correspondence$Precursor.Id),]
protein_mat <- protein_summarize_medianpolish(DM = raw_prec_data,
protein_ids = precursor_protein_correspondence$Protein.Ids)
# Run differential expression analysis
## I am not sure how to do this! Should I check DE for all strains w.r.t. to a single baseline one? Or should I do it separately for each culture method (pellet, liquid, liquid+fluconazole)??? For now I am going to run it once for all strains with C0L (lab strain, passage 0, liquid media) as a reference and see what happens
de_analysis_results <- de_analysis(raw_data = protein_mat,
metadata = metadata,
method = "proDA",
strain_name_column = "Strain.Name",
sample_name_column = "Sample.Name",
reference_strain = "C0L")
library(proDA)
# Run differential expression analysis
## I am not sure how to do this! Should I check DE for all strains w.r.t. to a single baseline one? Or should I do it separately for each culture method (pellet, liquid, liquid+fluconazole)??? For now I am going to run it once for all strains with C0L (lab strain, passage 0, liquid media) as a reference and see what happens
de_analysis_results <- de_analysis(raw_data = protein_mat,
metadata = metadata,
method = "proDA",
strain_name_column = "Strain.Name",
sample_name_column = "Sample.Name",
reference_strain = "C0L")
raw_data = protein_mat
metadata = metadata
method = "proDA"
strain_name_column = "Strain.Name"
sample_name_column = "Sample.Name"
reference_strain = "C0L"
N = 10
lfc_threshold = 1
alpha = 0.05
# Generate the design matrix
## Get the names of all strains, and set the reference strain
my_levels <- c()
for (i in 1:ncol(raw_data)) {
sample_name <- colnames(raw_data)[i]
strain_name <- metadata[[strain_name_column]][metadata[[sample_name_column]] == sample_name]
if (length(strain_name) > 1) {
strain_name <- strain_name[1]
}
my_levels <- c(my_levels, strain_name)
}
my_levels <- as.factor(my_levels)
my_levels <- relevel(my_levels, ref = reference_strain)
## Generate design matrix
mm <- model.matrix(~ 0 + my_levels)
colnames(mm) <- levels(my_levels)
# Fit linear models
fit <- switch(
method,
"limma" = lmFit(raw_data, mm),
"limpa" = dpcDE(y.protein, mm),
"proDA" = proDA(raw_data, mm)
)
colMeans(is.na(raw_data))   # missingness per sample
rowMeans(is.na(raw_data))
prot_mat <- raw_data
apply(prot_mat, 1, function(x) sum(is.na(x)) == ncol(prot_mat))
sum(apply(prot_mat, 1, function(x) sum(is.na(x)) == ncol(prot_mat)))
nrows(prot_mat)
nrow(prot_mat)
hist(apply(prot_mat, 1, function(x) sum(is.na(x))))
# Remove proteins (rows) which are missing in all samples
prot_mat <- prot_mat[!(apply(prot_mat, 1, function(x) sum(is.na(x)) == ncol(prot_mat))),]
hist(apply(prot_mat, 1, function(x) sum(is.na(x))))
protein_mat <- protein_mat[!(apply(protein_mat, 1, function(x) sum(is.na(x)) == ncol(protein_mat))),]
# Run differential expression analysis
## I am not sure how to do this! Should I check DE for all strains w.r.t. to a single baseline one? Or should I do it separately for each culture method (pellet, liquid, liquid+fluconazole)??? For now I am going to run it once for all strains with C0L (lab strain, passage 0, liquid media) as a reference and see what happens
de_analysis_results <- de_analysis(raw_data = protein_mat,
metadata = metadata,
method = "proDA",
strain_name_column = "Strain.Name",
sample_name_column = "Sample.Name",
reference_strain = "C0L")
# Run differential expression analysis
## I am not sure how to do this! Should I check DE for all strains w.r.t. to a single baseline one? Or should I do it separately for each culture method (pellet, liquid, liquid+fluconazole)??? For now I am going to run it once for all strains with C0L (lab strain, passage 0, liquid media) as a reference and see what happens
de_analysis_results <- de_analysis(raw_data = protein_mat,
metadata = metadata,
method = "limma",
strain_name_column = "Strain.Name",
sample_name_column = "Sample.Name",
reference_strain = "C0L")
sum(is.na(protein_mat)/(nrow(protein_mat)*ncol(protein_mat)))
remove_uncommon_precursors_per_strain <- function(data,
percentage_of_samples_per_precursor) {
# Set up the filter
filterSF <- data %>%
dplyr::group_by(Precursor.Id, Strain.Name) %>%
dplyr::summarise(count = n()) %>%
dplyr::ungroup() %>%
dplyr::group_by(Strain.Name) %>%
dplyr::mutate(maxCount=max(count)) %>%
dplyr::ungroup()
# Apply filter
out <- data %>%
dplyr::left_join(filterSF) %>%
dplyr::filter(count >= percentage_of_samples_per_precursor*maxCount)
return(out)
}
# Remove proteins which are present in less than 65% of the samples per strain
## Switch to longer format for filtering
protein_mat$Precursor.Id <- rownames(protein_mat)
protein_mat_long <- pivot_longer(protein_mat,
cols = -Precursor.Id,
names_to = Strain.Name,
values_to = Protein.Intensity) %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = Strain.Name,
values_from = Protein.Intensity) %>%
set_column_as_rownames(Precursor.Id)
View(protein_mat)
# Run summarization
protein_mat <- protein_summarize_medianpolish(DM = raw_prec_data,
protein_ids = precursor_protein_correspondence$Protein.Ids)
# Remove proteins which are present in less than 65% of the samples per strain
## Switch to longer format for filtering
protein_mat$Precursor.Id <- rownames(protein_mat)
# Run summarization
protein_mat <- as.data.frame(protein_summarize_medianpolish(DM = raw_prec_data,
protein_ids = precursor_protein_correspondence$Protein.Ids))
# Remove proteins which are present in less than 65% of the samples per strain
## Switch to longer format for filtering
protein_mat$Precursor.Id <- rownames(protein_mat)
protein_mat_long <- pivot_longer(protein_mat,
cols = -Precursor.Id,
names_to = Strain.Name,
values_to = Protein.Intensity) %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = Strain.Name,
values_from = Protein.Intensity) %>%
set_column_as_rownames(Precursor.Id)
protein_mat_long <- pivot_longer(protein_mat,
cols = -Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = Strain.Name,
values_from = Protein.Intensity) %>%
set_column_as_rownames(Precursor.Id)
protein_mat_long <- pivot_longer(protein_mat,
cols = -Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = "Strain.Name",
values_from = "Protein.Intensity") %>%
set_column_as_rownames(Precursor.Id)
# Remove proteins which are present in less than 65% of the samples per strain
## Switch to longer format for filtering
protein_mat$Precursor.Id <- rownames(protein_mat)
protein_mat_long <- pivot_longer(protein_mat,
cols = -Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = "Strain.Name",
values_from = "Protein.Intensity") %>%
set_column_as_rownames(Precursor.Id)
protein_mat_long <- pivot_longer(protein_mat,
cols = !Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = "Strain.Name",
values_from = "Protein.Intensity") %>%
set_column_as_rownames(Precursor.Id)
protein_mat$Precursor.Id
protein_mat_long <- pivot_longer(protein_mat,
cols = !Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity")
protein_mat_long <- pivot_longer(protein_mat,
cols = !Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65)
protein_mat_long <- pivot_longer(protein_mat,
cols = !Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = "Strain.Name",
values_from = "Protein.Intensity")
View(protein_mat_long)
remove_uncommon_precursors_per_strain <- function(data,
percentage_of_samples_per_precursor) {
# Set up the filter
filterSF <- data %>%
dplyr::group_by(Precursor.Id, Strain.Name) %>%
dplyr::summarise(count = n()) %>%
dplyr::ungroup() %>%
dplyr::group_by(Strain.Name) %>%
dplyr::mutate(maxCount=max(count)) %>%
dplyr::ungroup()
# Apply filter
out <- data %>%
dplyr::left_join(filterSF) %>%
dplyr::filter(count >= percentage_of_samples_per_precursor*maxCount) %>%
dplyr::select(-c(count, maxCount))
return(out)
}
protein_mat_long <- pivot_longer(protein_mat,
cols = !Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = "Strain.Name",
values_from = "Protein.Intensity") %>%
set_column_as_rownames("Precursor.Id")
protein_mat_long <- pivot_longer(protein_mat,
cols = !Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = "Strain.Name",
values_from = "Protein.Intensity") %>%
as.data.frame() %>%
set_column_as_rownames("Precursor.Id")
View(protein_mat_long)
protein_mat_long <- pivot_longer(protein_mat,
cols = !Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
dplyr::filter(!is.na(Protein.Intensity)) %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = "Strain.Name",
values_from = "Protein.Intensity") %>%
as.data.frame() %>%
set_column_as_rownames("Precursor.Id")
View(protein_mat_long)
# Run differential expression analysis
## I am not sure how to do this! Should I check DE for all strains w.r.t. to a single baseline one? Or should I do it separately for each culture method (pellet, liquid, liquid+fluconazole)??? For now I am going to run it once for all strains with C0L (lab strain, passage 0, liquid media) as a reference and see what happens
de_analysis_results <- de_analysis(raw_data = protein_mat,
metadata = metadata,
method = "limma",
strain_name_column = "Strain.Name",
sample_name_column = "Sample.Name",
reference_strain = "C0L")
protein_mat <- pivot_longer(protein_mat,
cols = !Precursor.Id,
names_to = "Strain.Name",
values_to = "Protein.Intensity") %>%
dplyr::filter(!is.na(Protein.Intensity)) %>%
remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%
pivot_wider(names_from = "Strain.Name",
values_from = "Protein.Intensity") %>%
as.data.frame() %>%
set_column_as_rownames("Precursor.Id")
# Run differential expression analysis
## I am not sure how to do this! Should I check DE for all strains w.r.t. to a single baseline one? Or should I do it separately for each culture method (pellet, liquid, liquid+fluconazole)??? For now I am going to run it once for all strains with C0L (lab strain, passage 0, liquid media) as a reference and see what happens
de_analysis_results <- de_analysis(raw_data = protein_mat,
metadata = metadata,
method = "limma",
strain_name_column = "Strain.Name",
sample_name_column = "Sample.Name",
reference_strain = "C0L")
sum(is.na(protein_mat))
sum(is.na(protein_mat))/(ncol(protein_mat)*nrow(protein_mat))
gc()
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(data.table)
library(limpa)
library(helperfunctions)
library(preprocessCore)
library(proDA)
working_from <- "charite"
if (working_from == "home") {
base_dir = "/home/alvaro/MyStuff/"
} else
if (working_from == "charite") {
base_dir = "C:/MyStuff/"
}
# Precursor data wide format
raw_prec_data <- as.matrix(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/report_wide_filtered_norm_drift_corrected_log2.csv", sep="")), rownames = 1)
# Metadata
metadata <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/metadata/metadata_processed.txt", sep="")))
# Correspondence between precursor IDs and protein IDs (UniProt)
precursor_protein_correspondence <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/precursor_protein_correspondence.tsv", sep="")))
# UniProt dataframe
uniprot_db <- as.data.frame(fread(paste(base_dir, "tRNA_KOs/Data/databases/uniprotkb_proteome_UP000002311_2025_05_24.tsv", sep="")))
# Prepare protein ID vector matching the precursor order in the rows of the raw data
## Set the order based on that of the rows of the precursor raw data
precursor_protein_correspondence <- precursor_protein_correspondence %>%
dplyr::filter(Precursor.Id %in% rownames(raw_prec_data))
precursor_protein_correspondence <- precursor_protein_correspondence[match(rownames(raw_prec_data), precursor_protein_correspondence$Precursor.Id),]
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(data.table)
library(limpa)
library(helperfunctions)
library(preprocessCore)
library(proDA)
working_from <- "charite"
if (working_from == "home") {
base_dir = "/home/alvaro/MyStuff/"
} else
if (working_from == "charite") {
base_dir = "C:/MyStuff/"
}
# Precursor data wide format
raw_prec_data <- as.matrix(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/report_wide_filtered_norm_drift_corrected_log2.csv", sep="")), rownames = 1)
# Metadata
metadata <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/metadata/metadata_processed.txt", sep="")))
# Correspondence between precursor IDs and protein IDs (UniProt)
precursor_protein_correspondence <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/precursor_protein_correspondence.tsv", sep="")))
# UniProt dataframe
uniprot_db <- as.data.frame(fread(paste(base_dir, "tRNA_KOs/Data/databases/uniprotkb_proteome_UP000002311_2025_05_24.tsv", sep="")))
# Prepare protein ID vector matching the precursor order in the rows of the raw data
## Set the order based on that of the rows of the precursor raw data
precursor_protein_correspondence <- precursor_protein_correspondence %>%
dplyr::filter(Precursor.Id %in% rownames(raw_prec_data))
precursor_protein_correspondence <- precursor_protein_correspondence[match(rownames(raw_prec_data), precursor_protein_correspondence$Precursor.Id),]
# Run summarization
protein_mat <- protein_summarize(DM = raw_prec_data,
protein_ids = precursor_protein_correspondence$Protein.Ids,
method = "limpa")
gc()
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(data.table)
library(limpa)
library(helperfunctions)
library(preprocessCore)
library(proDA)
working_from <- "charite"
if (working_from == "home") {
base_dir = "/home/alvaro/MyStuff/"
} else
if (working_from == "charite") {
base_dir = "C:/MyStuff/"
}
# Precursor data wide format
raw_prec_data <- as.matrix(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/report_wide_filtered_norm_drift_corrected_log2.csv", sep="")), rownames = 1)
# Metadata
metadata <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/metadata/metadata_processed.txt", sep="")))
# Correspondence between precursor IDs and protein IDs (UniProt)
precursor_protein_correspondence <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/precursor_protein_correspondence.tsv", sep="")))
# UniProt dataframe
uniprot_db <- as.data.frame(fread(paste(base_dir, "tRNA_KOs/Data/databases/uniprotkb_proteome_UP000002311_2025_05_24.tsv", sep="")))
# Prepare protein ID vector matching the precursor order in the rows of the raw data
## Set the order based on that of the rows of the precursor raw data
precursor_protein_correspondence <- precursor_protein_correspondence %>%
dplyr::filter(Precursor.Id %in% rownames(raw_prec_data))
precursor_protein_correspondence <- precursor_protein_correspondence[match(rownames(raw_prec_data), precursor_protein_correspondence$Precursor.Id),]
# Run summarization
protein_mat <- protein_summarize(raw_data = raw_prec_data,
protein_ids = precursor_protein_correspondence$Protein.Ids,
method = "limpa")
sum(is.na(precursor_protein_correspondence$Protein.Ids))
