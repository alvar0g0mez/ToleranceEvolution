---
title: "Preprocessing_simplified"
author: "Álvaro Gómez Pérez"
date: "2025-11-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Packages
```{r}
library(data.table)
library(dplyr)
library(readODS)
library(kableExtra)
library(gridExtra)
library(ggplot2)
library(glue)
library(gt)
library(ggvenn)
library(ggrepel)
library(diann)
library(ggpubr)
library(forcats)
library(tidyr)
library(helperfunctions)
library(impute)
```


Load data
```{r}
# Raw precursor-level report
report_raw <- as.data.frame(fread("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Raw/report.tsv"))
report_raw_head <- report_raw[1:500,]
print(glue("Number of unique precursors in raw report: {length(unique(report_raw$Precursor.Id))}"))

# Stats file
stats_file <- as.data.frame(fread("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Raw/report.stats.tsv"))

# Metadata
metadata <- as.data.frame(fread("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/metadata/metadata_processed.txt"))
metadata_temp <- metadata %>%
  dplyr::select(File.Name, Strain.Name, Analysis.Row, Analysis.Column, Sample.Name, Sample.Type, Strain.Type, Passage, Treatment)

# Add metadata columns to report and keep only columns of interest
report_raw_matched <- report_raw %>%
  dplyr::select(File.Name, Protein.Group, Protein.Ids, Protein.Names, Genes, Modified.Sequence, Stripped.Sequence, Precursor.Id, Precursor.Quantity, Precursor.Normalised, Proteotypic, Q.Value, PG.Q.Value, Global.Q.Value, Global.PG.Q.Value, Lib.Q.Value, RT) %>%
  left_join(metadata, by = "File.Name")
report_raw_matched_head <- report_raw_matched[1:500,]

# Add a couple columns of interest from the metadata to the stats file as well
metadata_temp <- metadata %>%
  dplyr::select(File.Name, Strain.Name, Sample.Name, Strain.Type, Passage, Treatment)
stats_file <- left_join(stats_file, metadata_temp, by = "File.Name")
rm(metadata_temp)

# Unique genes
unique_genes <- as.data.frame(fread("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Raw/report.unique_genes_matrix.tsv"))
```


# 0. Set up
## 0.1. Parameters
```{r}
Q_values_threshold = 0.01
min_samples_per_strain = 3
percentage_of_samples_per_precursor = 0.65
SD_limit_for_TIC_filtering = 2
quantile_limit_QC_CV = 0.95
```


## 0.2. Set up table to keep track of changes in each step
Also add in the first row the information about all samples (including those with 100% missing values), coming from unique_genes
```{r}
changes_log <- tibble(Step_no = numeric(),
                      Step_description =  character(),
                      Step_name = character(),
                      Samples_count =  numeric(),
                      QCs_count = numeric(),
                      WTs_count = numeric(),
                      Excluded_samples_count = numeric(),
                      Excluded_samples = character(),
                      Strains_present = numeric(),
                      Strains_removed = character(),
                      Report_row_count = numeric(),
                      Unique_precursor_count = numeric(),
                      Protein_ID_count = numeric(),
                      Genes_count = numeric(),
                      NA_proportion = numeric())

strains_present = unique(report_raw_matched$Strain.Name)

new_row <- tibble(
  Step_no = 0, 
  Step_description = "Starting dataset",
  Step_name = "Raw",
  Samples_count = length(unique(report_raw_matched$Sample.ID.unique[report_raw_matched$Strain.Name != "WT" & report_raw_matched$Strain.Name != "QC"])), 
  QCs_count = sum(metadata$Strain.Name == "QC"),
  WTs_count = sum(metadata$Strain.Name == "WT"),
  Excluded_samples_count = NA,  
  Excluded_samples = "-",
  Strains_present = length(strains_present),
  Strains_removed = NA,
  Report_row_count = nrow(report_raw_matched),              # What should I do with this??? I´m gonna have the same amount of rows bc those samples are empty lol. Same for the things in the next lines
  Unique_precursor_count = length(unique(report_raw_matched$Precursor.Id)),
  Protein_ID_count = length(unique(report_raw_matched$Protein.Ids)),
  Genes_count = length(unique(report_raw_matched$Genes)),
  NA_proportion = check_NA_proportion_in_DIA_NN_report(report_raw_matched))

changes_log <- changes_log %>%
  add_row(new_row)



# Create the function which will create the new log row after every filtering step
get_new_row_for_log <- function(step_number,
                                step_description,
                                step_name,
                                old_df,
                                new_df) {
  # Samples removed in this step
  excluded_samples <- setdiff(unique(old_df$Sample.Name),
                              unique(new_df$Sample.Name))
  
  # Strains removed in this step and remaining strains
  strains_old <- unique(old_df$Strain.Name)
  strains_new <- unique(new_df$Strain.Name)
  strains_removed <- strains_old[!(strains_old %in% strains_new)]
  
  # Create new row
  new_row <- tibble(
    Step_no = step_number, 
    Step_description = glue(step_description),
    Step_name = glue(step_name),
    Samples_count = length(unique(new_df$Sample.Name[new_df$Strain.Name != "QC" & new_df$Strain.Name != "WT"])), 
    QCs_count = length(unique(new_df$Sample.Name[new_df$Strain.Name == "QC"])),
    WTs_count = length(unique(new_df$Sample.Name[new_df$Strain.Name == "WT"])),
    Excluded_samples_count = length(excluded_samples),  
    Excluded_samples = paste(excluded_samples, collapse = ", "),
    Strains_present = length(strains_new),
    Strains_removed = paste(strains_removed, collapse = ", "),
    Report_row_count = nrow(new_df),
    Unique_precursor_count = length(unique(new_df[["Precursor.Id"]])),
    Protein_ID_count = length(unique(new_df$Protein.Ids)),
    Genes_count = length(unique(new_df$Genes)),
    NA_proportion = check_NA_proportion_in_DIA_NN_report(new_df))
}
```





# 1. Remove non-proteotypic precursors
## 1.1. Remove them
```{r}
# Run filtering
data_filtered_proteotypic <- filter_proteotypic(report_raw_matched)

print(glue("Number of unique precursors after proteotypicity filter: {length(unique(data_filtered_proteotypic$Precursor.Id))}"))
```


## 1.2. Update change log
```{r}
new_row <- get_new_row_for_log(1, 
                               step_description = "Removed non-proteotypic precursors",
                               step_name = "Proteotypicity",
                               report_raw_matched,
                               data_filtered_proteotypic)

changes_log <- changes_log %>%
  add_row(new_row)
```




# 2. Remove identified but not quantified precursors
## 2.1. Remove them
```{r}
# Run filtering
data_filtered_quantified <- filter_quantified(data_filtered_proteotypic)

print(glue("Number of unique precursors after removing non-quantified precursors: {length(unique(data_filtered_quantified$Precursor.Id))}"))
```


## 2.2. Update change log
```{r}
new_row <- get_new_row_for_log(2, 
                               "Removed non quantified precursors",
                               step_name = "Non-quantified",
                               data_filtered_proteotypic,
                               data_filtered_quantified)

changes_log <- changes_log %>%
  add_row(new_row)
```



# 3. Filter based on Q-values
## 3.1. Perform filtering
```{r}
# Remove already unnecessary version of the report (2 steps ago)
rm(data_filtered_proteotypic)

# Run filtering
q_values_to_filter <- list("Q.Value", "PG.Q.Value", "Global.Q.Value")
data_filtered_Q <- filter_q_values(data = data_filtered_quantified, 
                                   threshold = Q_values_threshold,
                                   q_values_to_filter = q_values_to_filter)

print(glue("Number of unique precursors after Q-value filtering: {length(unique(data_filtered_Q$Precursor.Id))}"))
```


## 3.2. Update change log
```{r}
new_row <- get_new_row_for_log(3, 
                               "Filtered all precursors with Q-value, PG.Q-Value, Global Q-Value, Global PG.Q-Value or Lib.Q.Value < 0.01",
                               step_name = "Q-values",
                               data_filtered_quantified,
                               data_filtered_Q)

changes_log <- changes_log %>%
  add_row(new_row)
```




# 4. Some general data quality checks at this point, after filtering but before all the rest of the pre-processing
## 4.0. Get completeness vs. mean intensity plot, coloring by injection order
Here I do this per sample, I think it might make more sense looking at it per precursor, so I do that further below
```{r}
# Transform to wide format so I can count the NAs per sample
data_filtered_Q_wide <- data_filtered_Q %>%
  dplyr::select(Sample.Name, Precursor.Normalised, Precursor.Id) %>%
  pivot_wider(values_from = Precursor.Normalised,
              names_from = Sample.Name) %>%
  as.data.frame() %>%
  set_column_as_rownames(column_name = "Precursor.Id")

# Bring this information of NAs per sample (as well as this as a ratio over the identified precursors) as new columns to the dataset and to the metadata 
na_count <- apply(data_filtered_Q_wide, 2, function(x) sum(is.na(x)))
na_count_df <- data.frame(colnames(data_filtered_Q_wide), na_count) 
colnames(na_count_df) <- c("Sample.Name", "NA_count")
na_count_df <- na_count_df %>%
  dplyr::mutate(Completeness = 1 - (NA_count/nrow(data_filtered_Q_wide)))
metadata_na_count <- left_join(metadata, na_count_df, by = "Sample.Name")

# Get the mean intensity column (just mean of Precursor.Normalised after grouping by Sample.Name)
data_filtered_Q_test <- left_join(data_filtered_Q, na_count_df, by = "Sample.Name") %>%
  group_by(Sample.Name) %>%
  dplyr::mutate(mean_Intensity = log2(mean(Precursor.Normalised))) %>%
  ungroup()

# Plot completeness vs. mean intensity per sample - colored by injection order
ggplot(data = data_filtered_Q_test, aes(x = mean_Intensity, y = Completeness, col = Injection)) +
  geom_point(size = 2) +
  theme_light() +
  scale_color_viridis_c() +
  xlab("mean Intensity")

# Boxplot for mean Intensity per condition -  first per condition, then coloring per each of the 3 variables
ggplot(data = data_filtered_Q_test, aes(x = Strain.Name, y = mean_Intensity, fill = Strain.Name)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  theme_light() +
  labs(x = NULL,
       y = "Mean intensity per sample",
       title = "Mean intensity per sample, for all conditions") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position = "none")

ggplot(data = data_filtered_Q_test, aes(x = Strain.Name, y = mean_Intensity, fill = Passage)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  theme_light() +
  labs(x = NULL,
       y = "Mean intensity per sample",
       title = "Mean intensity per sample, for all conditions") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggplot(data = data_filtered_Q_test, aes(x = Strain.Name, y = mean_Intensity, fill = Treatment)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  theme_light() +
  labs(x = NULL,
       y = "Mean intensity per sample",
       title = "Mean intensity per sample, for all conditions") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggplot(data = data_filtered_Q_test, aes(x = Strain.Name, y = mean_Intensity, fill = Strain.Type)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  theme_light() +
  labs(x = NULL,
       y = "Mean intensity per sample",
       title = "Mean intensity per sample, for all conditions") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

# Boxplot for missingness per strain - first per condition, then coloring per each of the 3 variables
ggplot(data = metadata_na_count, aes(x = Strain.Name, y = Completeness, fill = Strain.Name)) +
  geom_boxplot() +
  theme_light() +
  scale_fill_viridis_d() +
  labs(x = NULL,
       y = "Completeness",
       title = "Completeness per condition") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position = "none")

ggplot(data = metadata_na_count, aes(x = Strain.Name, y = Completeness, fill = Passage)) +
  geom_boxplot() +
  theme_light() +
  scale_fill_viridis_d() +
  labs(x = NULL,
       y = "Completeness",
       title = "Completeness per condition") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggplot(data = metadata_na_count, aes(x = Strain.Name, y = Completeness, fill = Treatment)) +
  geom_boxplot() +
  theme_light() +
  scale_fill_viridis_d() +
  labs(x = NULL,
       y = "Completeness",
       title = "Completeness per condition") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggplot(data = metadata_na_count, aes(x = Strain.Name, y = Completeness, fill = Strain.Type)) +
  geom_boxplot() +
  theme_light() +
  scale_fill_viridis_d() +
  labs(x = NULL,
       y = "Completeness",
       title = "Completeness per condition") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

Actually figure out completeness per precursor
```{r}
# Grab NAs per precursor and bring that information to the long-format DIA-NN report
na_count <- apply(data_filtered_Q_wide, 1, function(x) sum(is.na(x)))
na_count_df <- data.frame(rownames(data_filtered_Q_wide), na_count) 
colnames(na_count_df) <- c("Precursor.Id", "NA_count")
na_count_df <- na_count_df %>%
  dplyr::mutate(Completeness = 1 - (NA_count/ncol(data_filtered_Q_wide)))

# Get the mean intensity column (just mean of Precursor.Normalised after grouping by Precursor.Id)
data_filtered_Q_test <- left_join(data_filtered_Q, na_count_df, by = "Precursor.Id") %>%
  group_by(Precursor.Id) %>%
  dplyr::mutate(mean_Intensity = log2(mean(Precursor.Normalised))) %>%
  ungroup()

ggplot(data = data_filtered_Q_test, aes(x = mean_Intensity, y = Completeness)) +
  geom_point(size = 0.3) +
  theme_light()
```



## 4.1. Also plots trying to explain missingness/completeness by grouping variables
```{r}
# By Strain.Type
ggplot(data = metadata_na_count, aes(x = Strain.Type, y = Completeness, fill = Strain.Type)) +
  geom_boxplot() +
  theme_light() +
  scale_fill_viridis_d()

# By Passage
ggplot(data = metadata_na_count, aes(x = Passage, y = Completeness, fill = Passage)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  theme_light()

# By Treatment
ggplot(data = metadata_na_count, aes(x = Treatment, y = Completeness, fill = Treatment)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  theme_light()

# By condition
ggplot(data = metadata_na_count, aes(x = Strain.Name, y = Completeness, fill = Strain.Name)) +
  geom_boxplot() +
  scale_fill_viridis_d() +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```


## 4.2. Calculate CVs across:
    - Sample (all the precursors identified in that sample)
    - Strain (all the levels included, this is, across biological replicates)
    - All samples
    - QC samples
    - Each of the levels of the strain variable: Strain.Type, Treatment and Passage --> tbh not sure this is necessary but I'll leave it there for now just in case
    
And create the following plots:
    - One like the typical one from the ScRAP: comparing the QC across all samples, across QCs, and across biological replicates, to see how good our replicates are basically
    - One where I put next to each other the CV for each of the strains, in order to see if any of them are particularly variable
    - Same as the previous one, but only based on Strain.Type
    - Same as the previous one, but only based on Treatment
    - Same as the previous one, but only based on Passage

Calculate CVs
```{r}
CV_data <- data_filtered_Q_test %>%
  dplyr::group_by(Strain.Name, Precursor.Id) %>%
  dplyr::mutate("CV_strain" = sd(Precursor.Normalised, na.rm = T)/mean(Precursor.Normalised, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(Precursor.Id) %>%
  dplyr::mutate("CV_all_samples" = sd(Precursor.Normalised, na.rm = T)/mean(Precursor.Normalised, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(Treatment, Precursor.Id) %>%
  dplyr::mutate("CV_treatment" = sd(Precursor.Normalised, na.rm = T)/mean(Precursor.Normalised, na.rm = T)) %>%
  dplyr::group_by(Passage, Precursor.Id) %>%
  dplyr::mutate("CV_passage" = sd(Precursor.Normalised, na.rm = T)/mean(Precursor.Normalised, na.rm = T)) %>%
  dplyr::group_by(Strain.Type, Precursor.Id) %>%
  dplyr::mutate("CV_strain_type" = sd(Precursor.Normalised, na.rm = T)/mean(Precursor.Normalised, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(QC_or_not = case_when(Strain.Name == "QC" ~ "QC",
                                      TRUE ~ "Biological replicates"))


# Turn CV data into long format in order to plot easily
CV_data_long <- bind_rows(CV_data %>% 
                  dplyr::filter(QC_or_not == "QC") %>% 
                  dplyr::transmute(Group = "QC", CV = CV_strain),
                
                CV_data %>% 
                  dplyr::filter(QC_or_not == "Biological replicates") %>% 
                  dplyr::transmute(Group = "Biological replicates", CV = CV_strain),
                
                CV_data %>% 
                  dplyr::transmute(Group = "All samples", CV = CV_all_samples))

CV_data_long_treatment <- CV_data %>%
  dplyr::select(CV_treatment, Treatment, Precursor.Id)
```

Create CV plots
```{r}
# CV per treatment group
CV_data %>%
  ggplot(aes(x = Treatment, y = CV_treatment, group = Treatment, fill = Treatment)) +
    geom_violin(draw_quantiles = c(0.5)) +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across treatment groups")

# CV per strain type
CV_data %>%
  ggplot(aes(x = Strain.Type, y = CV_strain_type, group = Strain.Type, fill = Strain.Type)) +
    geom_violin(draw_quantiles = c(0.5)) +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across strains")

# CV per passage
CV_data %>%
  ggplot(aes(x = Passage, y = CV_passage, group = Passage, fill = Passage)) +
    geom_violin(draw_quantiles = c(0.5)) +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across passages")

# CV per treatment+strain type+passage - violin
CV_data %>%
  ggplot(aes(x = Strain.Name, y = CV_strain, group = Strain.Name, fill = Strain.Name)) +
    geom_violin(draw_quantiles = c(0.5)) +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across all conditions") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

# CV per treatment+strain type+passage - boxplot
CV_data %>%
  ggplot(aes(x = Strain.Name, y = CV_strain, group = Strain.Name, fill = Strain.Name)) +
    geom_boxplot(draw_quantiles = c(0.5)) +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across all conditions") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

# CV comparison: per strain (across biological replicates), across all strains, and across CVs
ggplot(data = CV_data_long, aes(x = Group, y = CV, fill = Group)) +
  geom_violin(draw_quantiles = c(0.5)) +
  scale_fill_viridis_d() +
  theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across different types of samples")

# Print the median CV across the QC samples - this is a reference of the quality of the whole dataset
median(CV_data_long$CV[CV_data_long$Group == "QC"], na.rm = T)
```


## 4.3. Get PCAs at precursor level at this point - on complete precursors only! 
This is, we use only the precursors which are present in every sample. Get complete cases and check how many precursors we end up with
```{r}
data_filtered_Q_wide_complete <- na.omit(data_filtered_Q_wide)

print(glue("Original number of precursors: {nrow(data_filtered_Q_wide)}"))
print(glue("Number of complete precursors across all samples: {nrow(data_filtered_Q_wide_complete)}"))
print(glue("Percentage of complete precursors across all samples: {nrow(data_filtered_Q_wide_complete)/nrow(data_filtered_Q_wide)}"))
```

Actually do the PCA
```{r}
# By Strain.Type
do_pca(data_filtered_Q_wide_complete,
       metadata,
       metadata_column_for_annotation = "Strain.Type",
       metadata_column_for_sample_name = "Sample.Name",
       threshold_for_no_imputation = 0.5,
       location_to_save = "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/filtering/pca/",
       save_as = "png")

# By Passage
do_pca(data_filtered_Q_wide_complete,
       metadata,
       metadata_column_for_annotation = "Passage",
       metadata_column_for_sample_name = "Sample.Name",
       threshold_for_no_imputation = 0.5,
       location_to_save = "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/filtering/pca/",
       save_as = "png")

# By Treatment
do_pca(data_filtered_Q_wide_complete,
       metadata,
       metadata_column_for_annotation = "Treatment",
       metadata_column_for_sample_name = "Sample.Name",
       threshold_for_no_imputation = 0.5,
       location_to_save = "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/filtering/pca/",
       save_as = "png")

# By injection order
do_pca(data_filtered_Q_wide_complete,
       metadata,
       metadata_column_for_annotation = "Injection",
       metadata_column_for_sample_name = "Sample.Name",
       threshold_for_no_imputation = 0.5,
       location_to_save = "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/filtering/pca/",
       save_as = "png")
```

## 4.4. Check how many precursors are uniquely detected in each condition/treatment/strain/passage
```{r}
# Create the function
get_num_of_unique_precursors_per_condition <- function(df,
                                                       metadata_column_to_check,
                                                       group_to_check) {
  precursors_in_group <- df %>%
    dplyr::filter(!!sym(metadata_column_to_check) == group_to_check) %>%
    dplyr::distinct(Precursor.Id) %>%
    dplyr::pull(Precursor.Id)
  
  precursors_outside_of_group <- df %>%
    dplyr::filter(!!sym(metadata_column_to_check) != group_to_check) %>%
    dplyr::distinct(Precursor.Id) %>%
    dplyr::pull(Precursor.Id)
  
  precursors_only_in_group <- precursors_in_group[!(precursors_in_group %in% precursors_outside_of_group)]
}

# Iterate over all 4 variables of interest and their levels, and save the results in a list
list_with_unique_precursors_per_condition <- list()
for (i in c("Strain.Type", "Treatment", "Passage", "Strain.Name")) {
  levels_in_variable <- unique(data_filtered_Q[[i]])
  for (j in levels_in_variable) {
    x <- get_num_of_unique_precursors_per_condition(data_filtered_Q,
                                                    i,
                                                    j)
    list_with_unique_precursors_per_condition[[paste(i, j, sep = "_")]] <- x
  }
}

# Get a barplot from this list, with the numbers of unique precursors in each of the levels of each variable
variable <- c()
num_of_unique_precursors <- c()
for (i in 1:length(list_with_unique_precursors_per_condition)) {
  x <- list_with_unique_precursors_per_condition[[i]]
  variable <- c(variable, names(list_with_unique_precursors_per_condition)[i])
  num_of_unique_precursors <- c(num_of_unique_precursors, length(x))
}
num_of_unique_precursors_df <- data.frame(variable, num_of_unique_precursors) %>%
  dplyr::filter(num_of_unique_precursors != 0) %>%
  dplyr::arrange(num_of_unique_precursors)

ggplot(data = num_of_unique_precursors_df, aes(x = fct_reorder(variable, num_of_unique_precursors), y = num_of_unique_precursors)) +
  geom_col() +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(title = "Number of unique precursors in different conditions") +
  xlab("") +
  ylab("Number of unique precursors")
```


Remove the outlying sample based on the PCA
```{r}
data_filtered_Q_no_outlier <- data_filtered_Q %>%
  dplyr::filter(Sample.Name != "I7F_2")
```



# 5. Filter based on z-score of TIC and number of precursors identified
## 5.0. Have a look at the stats file myself
```{r}
# Plot the distribution of these 2 variables
ggplot(data = stats_file, aes(x = Precursors.Identified)) +
  geom_histogram(col = "black", fill = "grey") +
  theme_light() +
  labs(title = "Distribution of precursors identified",
       subtitle = "Across all samples") +
  xlab("Count")

ggplot(data = stats_file, aes(x = MS1.Signal)) +
  geom_histogram(col = "black", fill = "grey") +
  theme_light() +
  labs(title = "Distribution of TIC",
       subtitle = "Across all samples") +
  xlab("Count")

# Look at the correlation between them - 0.74, rather high, so I can just filter based on one of them. 
cor(stats_file$Precursors.Identified, stats_file$MS1.Signal)
```

--> Not filtering based on the Z-scores - just removing one sample with an extremely low TIC and number of precursors identified. 

## 5.1. Filtering
```{r}
# Identify the sample with the very low TIC and number of precursors identified
sample_to_remove <- stats_file$Sample.Name[stats_file$MS1.Signal < 20000000000]

# Filter it out
data_filtered_TIC <- data_filtered_Q_no_outlier %>%
  dplyr::filter(!grepl(sample_to_remove, Sample.Name))
```


## 5.2. Update change log
```{r}
new_row <- get_new_row_for_log(4, 
                               "Filtered all samples with robust z-score for TIC or number of identified peptides more than 2*SD away from the mean z-score",
                               step_name = "Z-scores",
                               data_filtered_Q,
                               data_filtered_TIC)

changes_log <- changes_log %>%
  add_row(new_row)
```





# 6. Filter based on detection threshold/sample fraction
## 6.1. Perform filtering based on number of samples present per strain
```{r}
# Remove already unnecessary version of the report (2 steps ago)
rm(data_filtered_quantified)

# Filter
data_filtered_replicate_num <- filter_samples_per_strain(data_filtered_TIC,
                                                              min_samples_per_strain)
```


## 6.2. Update change log
```{r}
new_row <- get_new_row_for_log(5, 
                               "Filtered strains with less than 3 replicates present",
                               step_name = "Replicate number",
                               data_filtered_TIC,
                               data_filtered_replicate_num)

changes_log <- changes_log %>%
  add_row(new_row)
```


## 6.3. Remove, for each strain, those precursors which are not present in at least 3/4 or 2/3 replicates
```{r}
data_filtered_prec_per_strain <- remove_uncommon_precursors_per_strain(data_filtered_replicate_num, 
                                                                       percentage_of_samples_per_precursor)
```


## 6.4. Update change log
```{r}
new_row <- get_new_row_for_log(6, 
                               "From each strain, removed precursors which were not present in more than 65% of the replicates",
                               step_name = "Rare precs. per strain",
                               data_filtered_replicate_num,
                               data_filtered_prec_per_strain)

changes_log <- changes_log %>%
  add_row(new_row)
```



# 7. Filter based on precursor CV
## 7.1. First of all I need to calculate the CV for each precursor across: QCs, biological replicates, and all samples, and plot their densities. 
```{r}
CV_data <- create_CV_data(data_filtered_prec_per_strain)
```

Density plot
```{r}
QC_CV_dist <- CV_data$CV_strain[CV_data$Strain.Name == "QC"]

ggplot() +
  geom_density(aes(x = CV_data$CV_strain[CV_data$Strain.Name != "QC" & CV_data$Strain.Name != "WT"], color = "Biological replicates"), linewidth = 0.8) +
  geom_density(aes(x = CV_data$CV_strain[CV_data$Strain.Name == "QC"], color = "QCs"), linewidth = 0.8) +
  geom_density(aes(x = CV_data$CV_all_samples, color = "All samples"), linewidth = 0.8) +
  scale_color_manual("CV across", values = c("Biological replicates" = "blue", "QCs" = "red", "All samples" = "darkgreen")) +
  xlab("Coefficient of variation (CV)") +
  ylab("Density") + 
  labs(title = "Densities of CV across different types of samples") +
  theme_light() + 
  coord_cartesian(xlim = c(0, 1)) +
  geom_vline(xintercept = quantile(CV_data$CV_strain[CV_data$Strain.Name == "QC"], probs = c(0.95)), linetype = "dashed", col = "black")

ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/filtering/CV_densities_precursor_level.png")
```


## 7.2. Filtering
Remove from all samples the precursors which have a large CV in the QCs
```{r}
data_filtered_by_QC_CV <- filter_by_CV(CV_data, quantile_limit_QC_CV)
```


## 7.3. Update change log
```{r}
new_row <- get_new_row_for_log(7, 
                               "Removed precursors with a CV over the 90% quantile across the QC samples ({quantile(QC_CV_dist, probs = c(0.9))})",
                               step_name = "CV filter",
                               data_filtered_prec_per_strain,
                               data_filtered_by_QC_CV)

changes_log <- changes_log %>%
  add_row(new_row)

changes_log_gt = changes_log %>% gt()
gtsave(changes_log_gt, file = "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/preprocessing_log.html")
```



# 8. Normalization
## 8.1. Evaluate the need for normalization
```{r}
## 1.1. Get scatter plot for identified precursors per sample vs. injection order
report <- add_injection_order_from_metadata_to_report(data_filtered_by_QC_CV, metadata)
report <- count_precursors_per_sample(report)

ggplot(data = report, aes(x = Injection_order, y = Precursors_per_sample, col = Sample.Type)) +
  geom_point() +
  theme_light() +
  xlab("Injection order") +
  ylab("Precursors per sample") +
  labs(title = "Identified precursors per sample") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/raw_report/precursors_per_sample_vs_injection_order_scatter.png", dpi = 600)

## 2.1. Get scatter plot for total intensity of all precursors identified per sample vs. injection order
report <- sum_precursor_intensities_per_sample(report)


# 1.2.1. Get boxplot for identified precursors per sample per strain - colored by Strain.Type
ggplot(data = report, aes(x = Strain.Name, y = Precursors_per_sample, col = Strain.Type)) +
  geom_boxplot() +
  theme_light() +
  xlab("Strain") +
  ylab("Precursors per sample") +
  labs(title = "Identified precursors per sample") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/raw_report/precursor_ids_per_sample_boxplot_per_strain_type.png", dpi = 600)

# 1.2.2. Get boxplot for identified precursors per sample per strain - colored by Passage
report %>%
  dplyr::mutate(Strain.Name = forcats::fct_relevel(Strain.Name, unique(Strain.Name[order(Passage)]))) %>%
  ggplot(aes(x = Strain.Name, y = Precursors_per_sample, col = Passage)) +
  geom_boxplot() +
  theme_light() +
  xlab("Strain") +
  ylab("Precursors per sample") +
  labs(title = "Identified precursors per sample") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/raw_report/precursor_ids_per_sample_boxplot_per_passage.png", dpi = 600)

# 1.2.3. Get boxplot for identified precursors per sample per strain - colored by Treatment
report %>%
  dplyr::mutate(Strain.Name = forcats::fct_relevel(Strain.Name, unique(Strain.Name[order(Treatment)]))) %>%
  ggplot(aes(x = Strain.Name, y = Precursors_per_sample, col = Treatment)) +
  geom_boxplot() +
  theme_light() +
  xlab("Strain") +
  ylab("Precursors per sample") +
  labs(title = "Identified precursors per sample") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/raw_report/precursor_ids_per_sample_boxplot_per_treatment.png", dpi = 600)
```
--> The Precursor.Normalised of all the samples are thankfully mostly aligned

## 8.2. Normalize
At this point we go from long to wide format data and log2! Necessary for this step and the following ones
```{r}
# Get wide version of the report
report_wide <- data_filtered_by_QC_CV %>%
  dplyr::select(Sample.Name, Precursor.Normalised, Precursor.Id) %>%
  pivot_wider(values_from = Precursor.Normalised,
              names_from = Sample.Name) %>%
  as.data.frame() %>%
  set_column_as_rownames(column_name = "Precursor.Id") %>%
  as.matrix()

# log2 transform - there are actually no 0s in DIA-NN report, but if there were, they would be set to NA
report_wide <- ifelse(report_wide == 0, NA, log2(report_wide))

# Normalization - median scaling
normalization_results <- normalize_median_scaling(df = report_wide,
                                                  exclude_outliers = F)
report_wide_norm <- normalization_results[["normalized_data"]]
norm_factors <- normalization_results[["normalization_factors"]]
mad_limits <- normalization_results[["mad_limits"]]

# Turn normalized data into long format
report_norm <- report_wide_norm %>%
  as.data.frame() %>%
  dplyr::mutate(Precursor.Id = rownames(report_wide_norm)) %>%
  pivot_longer(cols = -Precursor.Id,
               names_to = "Sample.Name",
               values_to = "Precursor.Normalised") %>%
  dplyr::filter(!is.na(Precursor.Normalised))

# Need to add the other columns
report <- report %>%
  dplyr::select(-Precursor.Normalised)
report_norm <- left_join(report_norm, report, by = c("Sample.Name", "Precursor.Id"))
```

## 8.3. Update change log
```{r}
new_row <- get_new_row_for_log(8, 
                               "Normalization",
                               step_name = "Normalization",
                               data_filtered_by_QC_CV,
                               report_norm)

changes_log <- changes_log %>%
  add_row(new_row)

changes_log_gt = changes_log %>% gt()
gtsave(changes_log_gt, file = "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/preprocessing_log.html")
```



Try out LOESS fit to injection time - NICE CHECK, SHOWS IT'S NOT NECESSARY TO CORRECT FOR DRIFT
```{r}
# First of all I need to collapse the Precursor.Normalised by sample, so I get the mean of it in each sample, and that is what I fit the model to
test <- report_norm %>%
  dplyr::group_by(Sample.Name) %>%
  dplyr::mutate(mean_Int_sample = mean(Precursor.Normalised, na.omit = T)) %>%
  dplyr::ungroup()

test <- test %>%
  dplyr::distinct(Sample.Name, .keep_all = T)

# Fit the model: the outcome is the mean Precursor.Normalised per sample, the regressor is the injection order
loess_fit <- loess(data = test, Precursor.Normalised ~ Injection)

# Get the plot and add the loess curve
ggplot(data = test, aes(x = Injection, y = Precursor.Normalised)) +
  geom_point() +
  geom_smooth(method = "loess",
              se = F) +
  theme_light() +
  labs(title = "Mean intensity per sample along injection order",
       subtitle = "With LOESS curve")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/filtering/loess_fit_to_injection_order.png")
```




# 9. Final QC and export of normalized data
## 9.1. Create wide version of the data again
```{r}
report_wide <- report_norm %>%
  dplyr::select(Sample.Name, Precursor.Normalised, Precursor.Id) %>%
  pivot_wider(values_from = Precursor.Normalised,
              names_from = Sample.Name) %>%
  as.data.frame() %>%
  set_column_as_rownames(column_name = "Precursor.Id") %>%
  as.matrix()
```

## 9.2. QC plots
```{r}
# 1.1. Get scatter plot for identified precursors per sample vs. injection order
ggplot(data = report_norm, aes(x = Injection, y = Precursors_per_sample, col = Sample.Type)) +
  geom_point() +
  theme_light() +
  xlab("Injection order") +
  ylab("Precursors per sample") +
  labs(title = "Identified precursors per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/precursor_ids_per_sample_scatter.png", dpi = 600)

# 2.1. Get scatter plot for total intensity of all precursors identified per sample vs. injection order
report_norm <- sum_precursor_intensities_per_sample(report_norm)

ggplot(data = report_norm, aes(x = Injection, y = Precursor_normalized_sum_per_sample, col = Sample.Type)) +
  geom_point() +
  theme_light() +
  xlab("Injection order") +
  ylab("Total Precursor.Normalised") +
  labs(title = "Sum of Precursor.Normalised per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())



# 1.2.1. Get boxplot for identified precursors per sample per strain - colored by Strain.Type
ggplot(data = report_norm, aes(x = Strain.Name, y = Precursors_per_sample, col = Strain.Type)) +
  geom_boxplot() +
  theme_light() +
  xlab("Strain") +
  ylab("Precursors per sample") +
  labs(title = "Identified precursors per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/precursor_ids_per_sample_boxplot_per_strain_type.png", dpi = 600)

# 1.2.2. Get boxplot for identified precursors per sample per strain - colored by Passage
report %>%
  dplyr::mutate(Strain.Name = forcats::fct_relevel(Strain.Name, unique(Strain.Name[order(Passage)]))) %>%
  ggplot(aes(x = Strain.Name, y = Precursors_per_sample, col = Passage)) +
  geom_boxplot() +
  theme_light() +
  xlab("Strain") +
  ylab("Precursors per sample") +
  labs(title = "Identified precursors per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/precursor_ids_per_sample_boxplot_per_passage.png", dpi = 600)

# 1.2.3. Get boxplot for identified precursors per sample per strain - colored by Treatment
report %>%
  dplyr::mutate(Strain.Name = forcats::fct_relevel(Strain.Name, unique(Strain.Name[order(Treatment)]))) %>%
  ggplot(aes(x = Strain.Name, y = Precursors_per_sample, col = Treatment)) +
  geom_boxplot() +
  theme_light() +
  xlab("Strain") +
  ylab("Precursors per sample") +
  labs(title = "Identified precursors per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/precursor_ids_per_sample_boxplot_per_treatment.png", dpi = 600)


# 2.2.1. Get boxplot for total intensity of all precursors identified per sample per strain - colored by Strain.Type
ggplot(data = report_norm, aes(x = Strain.Name, y = Precursor_normalized_sum_per_sample, col = Strain.Type)) +
  geom_boxplot() +
  theme_light() +
  xlab("Strain") +
  ylab("Total Precursor.Normalised") +
  labs(title = "Sum of Precursor.Normalised per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

# 2.2.2. Get boxplot for total intensity of all precursors identified per sample per strain - colored by Passage
report %>%
  dplyr::mutate(Strain.Name = forcats::fct_relevel(Strain.Name, unique(Strain.Name[order(Passage)]))) %>%
  ggplot(aes(x = Strain.Name, y = Precursor_normalized_sum_per_sample, col = Passage)) +
  geom_boxplot() +
  theme_light() +
  xlab("Strain") +
  ylab("Total Precursor.Normalised") +
  labs(title = "Sum of Precursor.Normalised per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

# 2.2.3. Get boxplot for total intensity of all precursors identified per sample per strain - colored by Treatment
report %>%
  dplyr::mutate(Strain.Name = forcats::fct_relevel(Strain.Name, unique(Strain.Name[order(Treatment)]))) %>%
  ggplot(aes(x = Strain.Name, y = Precursor_normalized_sum_per_sample, col = Treatment)) +
  geom_boxplot() +
  theme_light() +
  xlab("Strain") +
  ylab("Total Precursor.Normalised") +
  labs(title = "Sum of Precursor.Normalised per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())



# 3.1. Boxplot of Precursor.Normalised per sample - colored by Strain.Type
report_norm %>%
  dplyr::mutate(File.Name = forcats::fct_relevel(File.Name, unique(File.Name[order(Strain.Type)]))) %>% 
  ggplot(aes(x = File.Name, y = log2(Precursor.Normalised), fill = Strain.Type)) +
  geom_boxplot() +
  theme_light() +
  xlab("Sample") +
  ylab("Precursor.Normalised") +
  labs(title = "Precursor.Normalised per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

# 3.1. Boxplot of Precursor.Normalised per sample - colored by Passage
report_norm %>%
  dplyr::mutate(File.Name = forcats::fct_relevel(File.Name, unique(File.Name[order(Passage)]))) %>% 
  ggplot(aes(x = File.Name, y = log2(Precursor.Normalised), fill = Passage)) +
  geom_boxplot() +
  theme_light() +
  xlab("Sample") +
  ylab("Precursor.Normalised") +
  labs(title = "Precursor.Normalised per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

# 3.1. Boxplot of Precursor.Normalised per sample - colored by Treatment
report_norm %>%
  dplyr::mutate(File.Name = forcats::fct_relevel(File.Name, unique(File.Name[order(Treatment)]))) %>% 
  ggplot(aes(x = File.Name, y = log2(Precursor.Normalised), fill = Treatment)) +
  geom_boxplot() +
  theme_light() +
  xlab("Sample") +
  ylab("Precursor.Normalised") +
  labs(title = "Precursor.Normalised per sample - after pre-processing") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

## 9.3. Protein summarization prior to imputation
```{r}
protein_summarized_no_imputation <- diann_maxlfq(report_norm,
                                                 sample.header = "Sample.Name",
                                                 group.header = "Protein.Ids",
                                                 id.header = "Precursor.Id",
                                                 quantity.header = "Precursor.Normalised")
protein_summarized_no_imputation_df <- data.frame(protein_summarized_no_imputation)

sum(is.na(protein_summarized_no_imputation))/(ncol(protein_summarized_no_imputation)*nrow(protein_summarized_no_imputation))

print(glue("Percentage of missing values at precursor level: {sum(is.na(report_wide))/(ncol(report_wide)*nrow(report_wide))}"))
print(glue("Percentage of missing values at protein level: {sum(is.na(protein_summarized_no_imputation))/(ncol(protein_summarized_no_imputation)*nrow(protein_summarized_no_imputation))}"))
```

## 9.4. Export data 
```{r}
# Filtered, normalized, non-imputed, precursor level data as wide format - to do imputation on
fwrite(report_wide, 
       "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Processed/filtered_normalized_log2_precursor_wide.csv",
       row.names = T)

# Filtered, normalized, non-imputed, precursor level data as long format
fwrite(report_norm,
       "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Processed/filtered_normalized_log2_precursor_long.tsv",
       row.names = T)

# Filtered, normalized, non-imputed, protein level data, wide format (always for protein-level data)
fwrite(protein_summarized_no_imputation_df,
       "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Processed/filtered_normalized_protein_wide.tsv",
       row.names = T)

# Correspondence between Precursor.Id and Protein.Id for limpa protein summarization in local
precursor_protein_correspondence <- report_raw %>%
  dplyr::select(Precursor.Id, Protein.Group, Protein.Ids, Genes) %>%
  dplyr::distinct(Precursor.Id, .keep_all = T)
fwrite(precursor_protein_correspondence,
       "/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Processed/precursor_protein_correspondence.tsv",
       row.names = T)
```



# 10. Imputation
I do recommend using the non-imputed dataset, but in case that the imputed one is required for whatever reason, I am producing it here, using KNN transposed imputation. 
```{r}
# Produce the imputed wide dataframe at precursor level


# Summarized the fully imputed dataframe to protein level


# Save both of these datasets
## Fully imputed, precursor level, wide


## Fully imputed, protein level, wide

```




# 11. More QC plots 
## 11.0. Load data (in case I don't want to run the whole filtering above)
```{r}
# Raw precursor-level report
report_raw <- as.data.frame(fread("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Raw/report.tsv"))

# Stats file
stats_file <- as.data.frame(fread("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Raw/report.stats.tsv"))

# Sample layout
metadata <- as.data.frame(fread("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/metadata/metadata_processed.txt"))
metadata_temp <- metadata %>%
  dplyr::select(File.Name, Strain.Name, Analysis.Row, Analysis.Column, Sample.Name, Sample.Type, Strain.Type, Passage, Treatment)

# Add sample layout columns to report and keep only columns of interest
report_raw_matched <- report_raw %>%
  dplyr::select(File.Name, Protein.Group, Protein.Ids, Protein.Names, Genes, Modified.Sequence, Stripped.Sequence, Precursor.Id, Precursor.Quantity, Precursor.Normalised, Proteotypic, Q.Value, PG.Q.Value, Global.Q.Value, Global.PG.Q.Value, Lib.Q.Value, RT) %>%
  left_join(metadata, by = "File.Name")

# Fully processed data
data_fully_processed <- as.data.frame(fread("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Data/Processed/filtered_normalized_log2_precursor_long.tsv"))

# Number of protein IDs at the beginning and end of pre-processing
length(unique(report_raw$Protein.Ids))
length(unique(data_fully_processed$Protein.Ids))

# Number of samples at the beginning and end of pre-processing
length(unique(report_raw$File.Name))
length(unique(data_fully_processed$Sample.Name))
```


## 11.1. Intensity distributions 
## 11.1.1. Precursor.Normalised - this is the one I work with
```{r}
ggplot(data = report_raw_matched, aes(x = Sample.Name, y = log2(Precursor.Normalised))) +
  geom_boxplot() +
  theme_light() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  xlab("Sample") +
  labs(title = "Intensity distribution - raw report")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/raw_report/intensity_distribution_raw.png", dpi = 600)

ggplot(data = data_fully_processed, aes(x = Sample.Name, y = Precursor.Normalised)) +
  geom_boxplot() +
  theme_light() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  xlab("Sample") +
  labs(title = "Intensity distribution - after filtering and normalization")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/intensity_distribution_processed.png", dpi = 600)
```

## 11.1.2. Precursor.Normalised boxplots along Injection time
```{r}
ggplot(data = report_raw_matched, aes(x = Injection, y = log2(Precursor.Normalised), group = Injection))+
  geom_boxplot() +
  theme_light()
```


## 11.2. Normalization factors
```{r}
# Point plot
ggplot(norm_factors, aes(x = Sample.Name, y = Norm_factor)) +
  geom_point() +
  geom_hline(yintercept = mad_limits[1], col = "orange") +
  geom_hline(yintercept = mad_limits[2], col = "orange") +
  theme_light() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  geom_text_repel(data = subset(norm_factors, Norm_factor > mad_limits[2]|Norm_factor < mad_limits[1]),
                  aes(x = Sample.Name, y = Norm_factor, label = Sample.Name)) +
  ylab("Normalization factor") +
  labs(title = "Normalization factors",
       subtitle = "Threshold at MAD = 2")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/normalization_factor_distribution.png", dpi = 600)

# Boxplots
temp_metadata <- metadata %>%
  dplyr::select(Sample.Name, Strain.Name, Strain.Type, Treatment, Passage)
normalization_factors_plot <- left_join(norm_factors, temp_metadata, by = "Sample.Name")

## By strain
ggplot(data = normalization_factors_plot, aes(x = Strain.Name, y = abs(Norm_factor), fill = Strain.Name)) +
  geom_boxplot() +
  theme_light() + 
  ylab("|Normalization factors|") +
  labs(title = "Absolute value of normalization factors per condition") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/norm_factors_boxplots_per_condition.png", dpi = 600)

## By strain type
ggplot(data = normalization_factors_plot, aes(x = Strain.Type, y = abs(Norm_factor), fill = Strain.Type)) +
  geom_boxplot() +
  theme_light() + 
  ylab("|Normalization factors|") +
  labs(title = "Absolute value of normalization factors per strain type")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/norm_factors_boxplots_per_strain_type.png", dpi = 600)

## By passage
ggplot(data = normalization_factors_plot, aes(x = Passage, y = abs(Norm_factor), fill = Passage)) +
  geom_boxplot() +
  theme_light() + 
  ylab("|Normalization factors|") +
  labs(title = "Absolute value of normalization factors per passage")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/norm_factors_boxplots_per_passage.png", dpi = 600)

## By treatment
ggplot(data = normalization_factors_plot, aes(x = Treatment, y = abs(Norm_factor), fill = Treatment)) +
  geom_boxplot() +
  theme_light() + 
  ylab("|Normalization factors|") +
  labs(title = "Absolute value of normalization factors per treatment")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/norm_factors_boxplots_per_treatment.png", dpi = 600)
```


## 11.3. Number of precursors identified along injection (scatterplot) - drift
```{r}
metadata_temp <- metadata %>%
  dplyr::select(File.Name, Injection)
stats_file <- left_join(stats_file, metadata_temp, by = "File.Name")

ggplot(data = stats_file, aes(x = Injection, y = Precursors.Identified)) +
  geom_point() +
  theme_light() +
  labs(title = "Number of identified precursors along injection")
```


## 11.4. Precursor.Quantity vs. Precusor.Normalised
Should do this one in the beginning, in order to decide to work with one or the other
```{r}
png()
ggplot(report_raw_matched, aes(x = Precursor.Quantity, y = Precursor.Normalised)) +
  geom_point() +
  geom_abline() +
  theme_light() +
  labs(title = "Match between Precursor.Normalised and Precursor.Quantity")

ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/raw_report/precursor_normalized_vs_precursor_quantity.png", dpi = 600)
```


## 11.5. Number of precursors across filtering steps
```{r}
changes_log_filtered <- changes_log %>%
  dplyr::filter(!grepl("2.0", Step_name)) %>% 
  dplyr::arrange(Step_no)
changes_log_filtered$Step_name <- factor(changes_log_filtered$Step_name, levels = unique(changes_log_filtered$Step_name))

ggplot(data = changes_log_filtered, aes(x = Step_name, y = Report_row_count)) +
  geom_col() +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  xlab("Filtering steps") +
  ylab("Count of report rows") +
  labs(title = "Count of rows in DIA-NN report along filtering steps")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/diann_report_rows_per_filtering_step.png", dpi = 600)

ggplot(data = changes_log_filtered, aes(x = Step_name, y = Unique_precursor_count)) +
  geom_col() +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  xlab("Filtering steps") +
  ylab("Count of unique precursors") +
  labs(title = "Count of unique precursors along filtering steps")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/unique_precursors_per_filtering_step.png", dpi = 600)

ggplot(data = changes_log_filtered, aes(x = Step_name, y = Protein_ID_count)) +
  geom_col() +
  theme_light() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  xlab("Filtering steps") +
  ylab("Count of protein IDs") +
  labs(title = "Count of protein IDs along filtering steps")
ggsave("/home/alvaro/MyStuff/Projects/ToleranceEvo_Wenxi/Output/Plots/QC/processed/protein_ids_per_filtering_step.png", dpi = 600)
```


## 11.6. CV plots after pre-processing
Calculate CVs
```{r}
# First I need to un-log2 transform the data, since CV can only be calculate in raw data, not log2 transformed
data_fully_processed <- data_fully_processed %>%
  dplyr::mutate(raw_intensities = 2^Precursor.Normalised)

# Calculate the CVs
start.time <- Sys.time()

CV_data <- data_fully_processed %>%
  dplyr::group_by(Strain.Name, Precursor.Id) %>%
  dplyr::mutate("CV_strain" = sd(raw_intensities, na.rm = T)/mean(raw_intensities, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(Precursor.Id) %>%
  dplyr::mutate("CV_all_samples" = sd(raw_intensities, na.rm = T)/mean(raw_intensities, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(Treatment, Precursor.Id) %>%
  dplyr::mutate("CV_treatment" = sd(raw_intensities, na.rm = T)/mean(raw_intensities, na.rm = T)) %>%
  dplyr::group_by(Passage, Precursor.Id) %>%
  dplyr::mutate("CV_passage" = sd(raw_intensities, na.rm = T)/mean(raw_intensities, na.rm = T)) %>%
  dplyr::group_by(Strain.Type, Precursor.Id) %>%
  dplyr::mutate("CV_strain_type" = sd(raw_intensities, na.rm = T)/mean(raw_intensities, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(QC_or_not = case_when(Strain.Name == "QC" ~ "QC",
                                      TRUE ~ "Biological replicates"))

end.time <- Sys.time()
time.taken <- end.time - start.time
glue("Time taken to create CV data: {time.taken} seconds")


# Turn CV data into long format in order to plot easily
CV_data_long <- bind_rows(CV_data %>% 
                  dplyr::filter(QC_or_not == "QC") %>% 
                  dplyr::transmute(Group = "QC", CV = CV_strain),
                
                CV_data %>% 
                  dplyr::filter(QC_or_not == "Biological replicates") %>% 
                  dplyr::transmute(Group = "Biological replicates", CV = CV_strain),
                
                CV_data %>% 
                  dplyr::transmute(Group = "All samples", CV = CV_all_samples))

CV_data_long_treatment <- CV_data %>%
  dplyr::select(CV_treatment, Treatment, Precursor.Id)
```

Plot
```{r}
# CV per treatment group
CV_data %>%
  ggplot(aes(x = Treatment, y = CV_treatment, group = Treatment, fill = Treatment)) +
    geom_violin(draw_quantiles = c(0.5)) +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across treatment groups")

# CV per strain type
CV_data %>%
  ggplot(aes(x = Strain.Type, y = CV_strain_type, group = Strain.Type, fill = Strain.Type)) +
    geom_violin(draw_quantiles = c(0.5)) +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across strains")

# CV per passage
CV_data %>%
  ggplot(aes(x = Passage, y = CV_passage, group = Passage, fill = Passage)) +
    geom_violin(draw_quantiles = c(0.5)) +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across passages")

# CV per treatment+strain type+passage - violin
CV_data %>%
  ggplot(aes(x = Strain.Name, y = CV_strain, group = Strain.Name, fill = Strain.Name)) +
    geom_violin(draw_quantiles = c(0.5)) +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across all conditions") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

# CV per treatment+strain type+passage - boxplot
CV_data %>%
  ggplot(aes(x = Strain.Name, y = CV_strain, group = Strain.Name, fill = Strain.Name)) +
    geom_boxplot() +
    scale_fill_viridis_d() +
    theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across all conditions") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  coord_cartesian(ylim = c(0, 2))

# CV comparison: per strain (across biological replicates), across all strains, and across CVs
ggplot(data = CV_data_long, aes(x = Group, y = CV, fill = Group)) +
  geom_violin(draw_quantiles = c(0.5)) +
  scale_fill_viridis_d() +
  theme_light() +
  labs(x = NULL,
       y = "CV",
       title = "CV across different types of samples")

# Print the median CV across the QC samples - this is a reference of the quality of the whole dataset
median(CV_data_long$CV[CV_data_long$Group == "QC"], na.rm = T)
```














