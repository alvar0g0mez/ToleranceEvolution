---
title: "ToleranceEvo_main"
author: "Álvaro Gómez Pérez"
date: "2025-07-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Libraries
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(data.table)
library(limpa)
library(helperfunctions)
library(preprocessCore)
library(proDA)
library(stringr)
```

Set up
```{r}
working_from <- "home"

if (working_from == "home") {
  base_dir = "/home/alvaro/MyStuff/"
} else
  if (working_from == "charite") {
    base_dir = "C:/MyStuff/"
  }
```


Load data
```{r}
# Precursor data wide format
raw_prec_data <- as.matrix(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/report_wide_filtered_norm_fully_imputed_drift_corrected_log2.csv", sep="")), rownames = 1)
hist(raw_prec_data)

# Metadata
metadata <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/metadata/metadata_processed.txt", sep="")))

# Correspondence between precursor IDs and protein IDs (UniProt) 
precursor_protein_correspondence <- as.data.frame(fread(paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/precursor_protein_correspondence.tsv", sep="")))

# UniProt dataframe
uniprot_db <- as.data.frame(fread(paste(base_dir, "tRNA_KOs/Data/databases/uniprotkb_proteome_UP000002311_2025_05_24.tsv", sep="")))
```




# 1. Differential expression analysis
Performed with limpa. Filtering and pre-processing at the precursor level was done in the cluster, here I start from the processed (filtered, normalized, drift corrected, MAR-only imputed) data at precursor level in wide format (precursors in rows, samples in columns), summarize to protein level and perform DE analysis, both with limpa.

## 1.1. Peptide to protein summarization
```{r}
# Prepare protein ID vector matching the precursor order in the rows of the raw data, setting the order based on that of the rows of the precursor raw data
precursor_protein_correspondence <- precursor_protein_correspondence %>%
  dplyr::filter(Precursor.Id %in% rownames(raw_prec_data))
precursor_protein_correspondence <- precursor_protein_correspondence[match(rownames(raw_prec_data), precursor_protein_correspondence$Precursor.Id),]

# Run summarization
protein_mat <- protein_summarize(raw_data = raw_prec_data,
                                 protein_ids = precursor_protein_correspondence$Protein.Ids,
                                 method = "limpa")

# Remove proteins which are present in less than 65% of the samples per strain - NOT NECESSARY RIGHT NOW SINCE I'M USING FULLY IMPUTED DATASET
#protein_mat <- as.data.frame(protein_mat)
#protein_mat$Precursor.Id <- rownames(protein_mat)
#protein_mat <- pivot_longer(protein_mat,                                                  # Switch to longer format for filtering
#                                 cols = !Precursor.Id,
#                                 names_to = "Strain.Name",
#                                 values_to = "Protein.Intensity") %>%
#  dplyr::filter(!is.na(Protein.Intensity)) %>%                                            # Remove rows with NAs, otherwise this filtering doesn't work (it's based on the     #                                                                                          row being present or not, not on its contents)
#  remove_uncommon_precursors_per_strain(percentage_of_samples_per_precursor = 0.65) %>%   # Filter
#  pivot_wider(names_from = "Strain.Name",                                                 # Set back to wide format
#              values_from = "Protein.Intensity") %>%
#  as.data.frame() %>%
#  set_column_as_rownames("Precursor.Id") 
#sum(is.na(protein_mat))
#sum(is.na(protein_mat))/(ncol(protein_mat)*nrow(protein_mat))

# Save protein level dataset
saveRDS(protein_mat, paste(base_dir, "ToleranceEvo_Wenxi/Data/Preprocessing_steps/protein_summarized_fully_imputed.rds", sep = ""))
```

## 1.2. Differential expression analysis
### 1.2.1. Separately for each treatment
I run into the issue that lab strain at passage 0 in fluconazole was removed during pre-processing. I think that's possibly expected, since it's a lab strain and it's had no time to adapt, fluconazole will kill it, hence it's understandable that the proteome we detect in it is quite messy. Should check this with Wenxi though. 
```{r}
# Divide the dataset into 3 based on culture type (pellet, liquid, liquid+fluconazole) and perform DE analysis separate for each, using lab strain at passage 0 as reference
treatments <- unique(metadata$Treatment)[!(unique(metadata$Treatment) == "QC")]
da_list <- list()
responsiveness_list <- list()

for (treatment in treatments) {
  # Grab the strains with this treatment
  samples_to_select <- metadata$Sample.Name[metadata$Treatment == treatment]
  temp_protein_mat <- protein_mat$y.protein$E[, colnames(protein_mat$y.protein$E) %in% samples_to_select]
  reference_strain <- unique(metadata$Strain.Name[metadata$Treatment == treatment &
                                             metadata$Passage == 0 &
                                             metadata$Strain.Type == "Lab strain"])[1]
  
  # Run differential expression analysis
  de_analysis_results <- de_analysis(raw_data = temp_protein_mat,
                                     metadata = metadata,
                                     method = "limma",
                                     strain_name_column = "Strain.Name", 
                                     sample_name_column = "Sample.Name", 
                                     reference_strain = reference_strain,
                                     N = 10,
                                     lfc_threshold = 1,
                                     alpha = 0.05)
  da <- de_analysis_results$DE_df
  da_list[[treatment]] <- da
  
  # Get responsiveness df
  resp <- create_responsiveness_df(da,
                                   lfc_threshold = 1,
                                   alpha = 0.05)
  responsiveness_list[[treatment]] <- resp
}



```

### 1.2.2. All strains together, using C0L as the reference
Decided to use this one because it's the lab strain, at passage 0, and in liquid because it's supposed to have had a bit more time to grow than the solid one
```{r}
de_analysis_results <- de_analysis(raw_data = protein_mat$y.protein,
                                   metadata = metadata,
                                   method = "limpa",
                                   strain_name_column = "Strain.Name", 
                                   sample_name_column = "Sample.Name", 
                                   reference_strain = "C0L",
                                   N = 10,
                                   lfc_threshold = 1,
                                   alpha = 0.05)
da <- de_analysis_results$DE_df

resp <- create_responsiveness_df(da,
                                 lfc_threshold = 1,
                                 alpha = 0.05)
```





Debug
```{r}
raw_data = protein_mat$y.protein
metadata = metadata
method = "limma"
strain_name_column = "Strain.Name"
sample_name_column = "Sample.Name"
reference_strain = "C0L"
lfc_threshold = 1
alpha = 0.05
N = 10
```







































